<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音声認識アプリ (類似検索版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 日本語フォント設定 (オプション) */
        body {
            font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif, "Hiragino Kaku Gothic ProN", "Meiryo", Meiryo, sans-serif;
        }
        /* ボタンのスタイル */
        .btn {
            @apply inline-block px-6 py-3 bg-blue-600 text-white font-medium text-sm leading-tight uppercase rounded-lg shadow-md hover:bg-blue-700 hover:shadow-lg focus:bg-blue-700 focus:shadow-lg focus:outline-none focus:ring-0 active:bg-blue-800 active:shadow-lg transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed;
        }
        /* 出力エリアのスタイル */
        .output-box {
            @apply mt-4 p-4 border border-gray-300 rounded-lg bg-gray-50 min-h-[100px];
        }
        /* ステータス表示エリアのスタイル */
        .status-box {
             @apply mt-2 text-sm text-gray-600;
        }
    </style>
</head>
<body class="container mx-auto p-6 bg-gray-100 flex flex-col items-center justify-center min-h-screen">

    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg text-center">
        <h1 class="text-2xl font-bold mb-6">音声認識アプリ (類似検索版)</h1>

        <button id="startButton" class="btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 0 0 6-6v-1.5m-6 7.5a6 6 0 0 1-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 0 1-3-3V4.5a3 3 0 1 1 6 0v8.25a3 3 0 0 1-3 3Z" />
            </svg>
            音声入力開始
        </button>

        <div id="statusArea" class="status-box mt-4">準備完了</div>

        <div class="mt-6 text-left">
            <h2 class="text-lg font-semibold mb-2">認識結果：</h2>
            <div id="outputArea" class="output-box">ここに認識結果に対応するテキストが表示されます。</div>
        </div>
         <div class="mt-6 text-left">
            <h2 class="text-lg font-semibold mb-2">認識された単語（最も近い登録語）：</h2>
            <div id="recognizedWordArea" class="output-box bg-gray-100">ここに認識された単語と、最も近い登録単語が表示されます。</div>
        </div>
    </div>

    <script>
        // --- 設定箇所：ここから ---

        // 認識させたい単語と、それに対応する出力テキストのマッピング
        // (変更なし、以前と同じように単語を追加してください)
        const wordMap = {
            // --- 例 ---
            'こんにちは': '挨拶：こんにちは！今日も一日頑張りましょう。',
            'ありがとう': '感謝：ありがとうございます。助かります。',
            'おはよう': '挨拶：おはようございます。良い一日を！',
            'さようなら': '別れ：さようなら。またお会いしましょう。',
            'はい': '肯定：はい、承知いたしました。',
            'いいえ': '否定：いいえ、違います。',
            'すみません': '謝罪/呼びかけ：すみません。',
            '助けて': '要求：助けてください！',
            '了解': '同意：了解しました。',
            '問題ない': '確認：問題ありません。',
            '疲れた': '状態：少し疲れました。休憩します。',
            '頑張る': '意気込み：頑張ります！',
            '最高': '評価：最高です！素晴らしい！',
            'ひどい': '評価：それはひどいですね。',
            'お腹すいた': '状態：お腹がすきました。何か食べたいです。',
            // --- ここから下に追加してください ---
            '天気': '話題：今日の天気はどうですか？',
            '雨': '天気：雨が降っていますね。',
            '晴れ': '天気：今日は晴れて気持ちがいいですね。',
            '曇り': '天気：曇っていますね。',
            '雪': '天気：雪が降ってきました。',
            // ... (さらに約180個の単語ペアを追加)
            // 例:
            // '赤': '色：赤色です。',
            // '青': '色：青色です。',
            // '黄色': '色：黄色です。',
            // '緑': '色：緑色です。',
            // '犬': '動物：ワンワン！犬が好きです。',
            // '猫': '動物：ニャー！猫もかわいいですね。',
            // 'りんご': '果物：りんごは美味しいですね。',
            // 'みかん': '果物：冬はみかんですね。',
            // '読む': '動作：本を読みます。',
            // '書く': '動作：手紙を書きます。',
            // '聞く': '動作：音楽を聴きます。',
            // '話す': '動作：友達と話します。',
            // '見る': '動作：映画を見ます。',
            // '食べる': '動作：ご飯を食べます。',
            // '飲む': '動作：水を飲みます。',
            // '寝る': '動作：そろそろ寝ます。',
            // '起きる': '動作：朝早く起きます。',
            // '行く': '動作：学校に行きます。',
            // '来る': '動作：友達が家に来ます。',
            // '帰る': '動作：家に帰ります。',
            // '勉強': '活動：日本語を勉強します。',
            // '仕事': '活動：仕事を頑張ります。',
            // '運動': '活動：健康のために運動します。',
            // '料理': '活動：夕食を料理します。',
            // '掃除': '活動：部屋を掃除します。',
            // '洗濯': '活動：洗濯物を干します。',
            // '買い物': '活動：スーパーへ買い物に行きます。',
            // '嬉しい': '感情：プレゼントをもらって嬉しいです。',
            // '楽しい': '感情：パーティーは楽しいです。',
            // '悲しい': '感情：映画を見て悲しくなりました。',
            // '怒る': '感情：約束を破られて怒っています。',
            // '驚く': '感情：サプライズに驚きました。',
            // '好き': '感情：寿司が好きです。',
            // '嫌い': '感情：ピーマンが嫌いです。',
            // '暑い': '気候：今日はとても暑いです。',
            // '寒い': '気候：冬は寒いです。',
            // '暖かい': '気候：春は暖かいです。',
            // '涼しい': '気候：秋は涼しいです。',
            // '大きい': 'サイズ：大きいカバンですね。',
            // '小さい': 'サイズ：小さい靴です。',
            // '高い': '価格/高さ：このビルは高いです。/ この時計は高いです。',
            // '安い': '価格：この服は安いです。',
            // '新しい': '状態：新しいパソコンを買いました。',
            // '古い': '状態：古い本を読んでいます。',
            // '良い': '評価：良い天気ですね。',
            // '悪い': '評価：体調が悪いです。',
            // '美味しい': '味：このケーキは美味しいです。',
            // 'まずい': '味：この料理はまずいです。',
            // '甘い': '味：チョコレートは甘いです。',
            // '辛い': '味：カレーは辛いです。',
            // 'しょっぱい': '味：このスープはしょっぱいです。',
            // '酸っぱい': '味：レモンは酸っぱいです。',
            // '苦い': '味：コーヒーは苦いです。',
            // '遠い': '距離：駅まで遠いです。',
            // '近い': '距離：コンビニは近いです。',
            // '速い': '速度：新幹線は速いです。',
            // '遅い': '速度：歩くのが遅いです。',
            // '重い': '重さ：荷物が重いです。',
            // '軽い': '重さ：羽のように軽いです。',
            // '簡単': '難易度：この問題は簡単です。',
            // '難しい': '難易度：数学は難しいです。',
            // '上手': '能力：日本語が上手ですね。',
            // '下手': '能力：絵を描くのが下手です。',
            // 'たくさん': '量：人がたくさんいます。',
            // '少し': '量：塩を少しください。',
            // '全部': '量：宿題は全部終わりました。',
            // '時間': '概念：今、何時ですか？',
            // 'お金': '概念：お金が足りません。',
            // '家族': '人間関係：家族と旅行に行きます。',
            // '友達': '人間関係：友達と遊びます。',
            // '先生': '人間関係：先生に質問します。',
            // '会社': '場所：会社で働いています。',
            // '学校': '場所：学校で勉強します。',
            // '家': '場所：家に帰ります。',
            // '駅': '場所：駅で電車を待ちます。',
            // '病院': '場所：病院に行きます。',
            // '店': '場所：店で買い物をします。',
            // '公園': '場所：公園で散歩します。',
            // '図書館': '場所：図書館で本を借ります。',
            // '映画館': '場所：映画館で映画を見ます。',
            // 'レストラン': '場所：レストランで食事します。',
            // '日本': '国：日本に住んでいます。',
            // '東京': '都市：東京は日本の首都です。',
            // '大阪': '都市：大阪は食い倒れの街です。',
            // '京都': '都市：京都には古いお寺がたくさんあります。',
            // '北海道': '地域：北海道は冬が寒いです。',
            // '沖縄': '地域：沖縄の海はきれいです。',
            // '春': '季節：春は桜が咲きます。',
            // '夏': '季節：夏は海に行きたいです。',
            // '秋': '季節：秋は紅葉が美しいです。',
            // '冬': '季節：冬は雪が降ります。',
            // '月曜日': '曜日：月曜日は週の始まりです。',
            // '火曜日': '曜日：火曜日に会議があります。',
            // '水曜日': '曜日：水曜日はノー残業デーです。',
            // '木曜日': '曜日：木曜日に飲み会があります。',
            // '金曜日': '曜日：金曜日は嬉しいです。',
            // '土曜日': '曜日：土曜日は休みです。',
            // '日曜日': '曜日：日曜日はゆっくりします。',
            // '今日': '時間：今日の予定は何ですか？',
            // '明日': '時間：明日は晴れるでしょうか？',
            // '昨日': '時間：昨日は何をしましたか？',
            // '朝': '時間：朝ごはんを食べました。',
            // '昼': '時間：お昼休みです。',
            // '夜': '時間：夜空がきれいです。',
            // '今': '時間：今、忙しいですか？',
            // '後で': '時間：後で連絡します。',
            // '前': '時間/位置：駅の前にいます。/ 食事の前に手を洗います。',
            // '右': '方向：右に曲がってください。',
            // '左': '方向：左側にあります。',
            // '上': '方向：机の上に本があります。',
            // '下': '方向：椅子の下に猫がいます。',
            // '中': '方向：箱の中に何がありますか？',
            // '外': '方向：外は寒いです。',
            // '隣': '位置：私の隣に座ってください。',
            // '近く': '位置：家の近くに公園があります。',
            // '電話': '道具：友達に電話します。',
            // 'パソコン': '道具：パソコンで作業します。',
            // 'テレビ': '道具：テレビを見ます。',
            // 'カメラ': '道具：カメラで写真を撮ります。',
            // '本': '物：本を読みます。',
            // '雑誌': '物：雑誌を買いました。',
            // '新聞': '物：新聞を読みます。',
            // '手紙': '物：手紙を書きます。',
            // 'ペン': '文房具：ペンで名前を書きます。',
            // '鉛筆': '文房具：鉛筆を削ります。',
            // '消しゴム': '文房具：消しゴムで消します。',
            // 'ノート': '文房具：ノートにメモします。',
            // '机': '家具：机の上を片付けます。',
            // '椅子': '家具：椅子に座ります。',
            // 'ベッド': '家具：ベッドで寝ます。',
            // 'ドア': '建具：ドアを開けます。',
            // '窓': '建具：窓を閉めます。',
            // '電気': '設備：電気をつけます。',
            // 'エアコン': '設備：エアコンを消します。',
            // '車': '乗り物：車を運転します。',
            // '電車': '乗り物：電車に乗ります。',
            // 'バス': '乗り物：バスで通勤します。',
            // '自転車': '乗り物：自転車で買い物に行きます。',
            // '飛行機': '乗り物：飛行機で旅行します。',
            // '船': '乗り物：船に乗って島に行きます。',
            // '食べ物': '食事：好きな食べ物は何ですか？',
            // '飲み物': '食事：飲み物はいかがですか？',
            // 'ご飯': '食事：ご飯を食べましょう。',
            // 'パン': '食事：朝食はパンです。',
            // '肉': '食材：肉料理が好きです。',
            // '魚': '食材：魚を焼きます。',
            // '野菜': '食材：野菜をたくさん食べましょう。',
            // '果物': '食材：果物は体にいいです。',
            // '水': '飲み物：水を一杯ください。',
            // 'お茶': '飲み物：緑茶が好きです。',
            // 'コーヒー': '飲み物：毎朝コーヒーを飲みます。',
            // 'ジュース': '飲み物：オレンジジュースをください。',
            // 'ビール': '飲み物：仕事の後にビールを飲みます。',
            // '服': '衣類：新しい服を買いました。',
            // 'ズボン': '衣類：ズボンを履きます。',
            // 'スカート': '衣類：スカートが好きです。',
            // 'シャツ': '衣類：白いシャツを着ます。',
            // '靴': '衣類：靴を磨きます。',
            // '帽子': '衣類：帽子をかぶります。',
            // 'カバン': '持ち物：カバンを持ちます。',
            // '時計': '持ち物：時計をしています。',
            // '眼鏡': '持ち物：眼鏡をかけます。',
            // '傘': '持ち物：雨が降りそうなので傘を持っていきます。',
            // '体': '身体：体の調子はどうですか？',
            // '頭': '身体：頭が痛いです。',
            // '顔': '身体：顔を洗います。',
            // '目': '身体：目が疲れました。',
            // '鼻': '身体：鼻がかゆいです。',
            // '口': '身体：口を開けてください。',
            // '耳': '身体：耳が聞こえにくいです。',
            // '手': '身体：手を繋ぎます。',
            // '足': '身体：足が速いです。',
            // '髪': '身体：髪を切りました。',
            // '心': '概念：心が落ち着きます。',
            // '名前': '情報：お名前は何ですか？',
            // '住所': '情報：住所を教えてください。',
            // '電話番号': '情報：電話番号を交換しましょう。',
            // '趣味': '情報：趣味は何ですか？',
            // 'スポーツ': '活動：何かスポーツをしますか？',
            // '音楽': '芸術：どんな音楽が好きですか？',
            // '映画': '芸術：最近、面白い映画を見ましたか？',
            // '旅行': '活動：旅行が好きです。',
            // 'ゲーム': '活動：ゲームをします。',
            // '写真': '芸術：写真を撮るのが好きです。',
            // '絵': '芸術：絵を描くのが趣味です。',
            // '色': '概念：好きな色は何ですか？',
            // '形': '概念：丸い形をしています。',
            // '数字': '概念：好きな数字はありますか？',
            // '質問': '行為：質問があります。',
            // '答え': '行為：答えを教えてください。',
            // '意味': '概念：この言葉の意味は何ですか？',
            // '理由': '概念：遅刻した理由は何ですか？',
            // '方法': '概念：駅までの行き方を教えてください。',
            // '練習': '行為：ピアノを練習します。',
            // '必要': '状態：パスポートが必要です。',
            // '大切': '評価：家族は大切です。',
            // '同じ': '比較：私と同じ意見です。',
            // '違う': '比較：それは少し違います。',
            // '次': '順序：次のバスはいつですか？',
            // '最後': '順序：これが最後のチャンスです。',
            // '初め': '順序：初めまして。',
            // '終わり': '順序：これで終わりです。',
            // 'ようこそ': '歓迎：ようこそ日本へ！',
            // 'おめでとう': '祝福：誕生日おめでとうございます！',
            // '気をつけて': '注意：気をつけて帰ってください。',
            // '大丈夫': '確認：大丈夫ですか？',
            // 'どうぞ': '勧誘：どうぞお座りください。',
            // 'もしもし': '電話：もしもし、田中です。',
            // 'ただいま': '帰宅：ただいま帰りました。',
            // 'おかえり': '帰宅：おかえりなさい。',
            // 'いただきます': '食事：いただきます。',
            // 'ごちそうさま': '食事：ごちそうさまでした。',
            // 'いってきます': '外出：いってきます。',
            // 'いってらっしゃい': '外出：いってらっしゃい。',
        };

        // --- 設定箇所：ここまで ---

        const startButton = document.getElementById('startButton');
        const outputArea = document.getElementById('outputArea');
        const statusArea = document.getElementById('statusArea');
        const recognizedWordArea = document.getElementById('recognizedWordArea');

        // --- レーベンシュタイン距離計算関数 ---
        function levenshteinDistance(s1, s2) {
            s1 = s1.toLowerCase();
            s2 = s2.toLowerCase();

            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else {
                        if (j > 0) {
                            let newValue = costs[j - 1];
                            if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            }
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        // --- 最も近い単語を見つける関数 ---
        function findBestMatch(transcript, map) {
            let minDistance = Infinity;
            let bestMatchKey = null;
            const keys = Object.keys(map);

            if (keys.length === 0) {
                return null; // マップが空の場合はnullを返す
            }

            for (const key of keys) {
                const distance = levenshteinDistance(transcript, key);
                if (distance < minDistance) {
                    minDistance = distance;
                    bestMatchKey = key;
                }
            }
            // 完全一致の場合も、最も近い単語として扱われる (距離が0になるため)
            return bestMatchKey;
        }


        // Web Speech APIの互換性チェック
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP'; // 言語を日本語に設定
            recognition.interimResults = false; // 途中結果は取得しない
            recognition.maxAlternatives = 1; // 候補は1つだけ取得

            // --- イベントハンドラ ---

            // 認識開始
            recognition.onstart = () => {
                statusArea.textContent = '音声認識中... 話してください。';
                startButton.disabled = true;
                startButton.classList.add('animate-pulse');
            };

            // 認識終了
            recognition.onend = () => {
                statusArea.textContent = '準備完了';
                startButton.disabled = false;
                 startButton.classList.remove('animate-pulse');
            };

            // 結果取得 (修正箇所)
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.trim(); // 認識された音声テキスト

                if (transcript === "") {
                     statusArea.textContent = '音声が空でした。';
                     recognizedWordArea.textContent = '';
                     outputArea.textContent = '';
                     return;
                }

                const bestMatchKey = findBestMatch(transcript, wordMap);

                if (bestMatchKey) {
                    outputArea.textContent = wordMap[bestMatchKey]; // 最も近い単語に対応するテキストを表示
                    if (transcript === bestMatchKey) {
                         recognizedWordArea.textContent = `「${transcript}」（完全一致）`;
                         statusArea.textContent = `「${transcript}」を認識しました。`;
                    } else {
                         recognizedWordArea.textContent = `認識：「${transcript}」→ 最も近い登録語：「${bestMatchKey}」`;
                         statusArea.textContent = `「${transcript}」に最も近い「${bestMatchKey}」として認識しました。`;
                    }
                } else {
                    // wordMapが空の場合など
                    outputArea.textContent = '比較対象の単語が登録されていません。';
                    recognizedWordArea.textContent = `認識：「${transcript}」`;
                    statusArea.textContent = '登録単語リストが空です。';
                }
            };

            // エラー処理
            recognition.onerror = (event) => {
                let errorMessage = '音声認識エラーが発生しました。';
                switch (event.error) {
                    case 'no-speech':
                        errorMessage = '音声が検出されませんでした。もう一度試してください。';
                        break;
                    case 'audio-capture':
                        errorMessage = 'マイクにアクセスできませんでした。設定を確認してください。';
                        break;
                    case 'not-allowed':
                        errorMessage = 'マイクの使用が許可されていません。';
                        break;
                    case 'network':
                         errorMessage = 'ネットワークエラーが発生しました。接続を確認してください。';
                         break;
                    default:
                        errorMessage = `エラー (${event.error}): ${event.message}`;
                }
                statusArea.textContent = errorMessage;
                outputArea.textContent = '';
                recognizedWordArea.textContent = '';
            };

            // --- ボタンのクリックイベント ---
            startButton.addEventListener('click', () => {
                try {
                    recognition.start();
                } catch (e) {
                    console.error("Recognition start error:", e);
                    statusArea.textContent = '認識を開始できませんでした。既に実行中かもしれません。';
                    startButton.disabled = false;
                    startButton.classList.remove('animate-pulse');
                }
            });

        } else {
            // Web Speech APIがサポートされていない場合
            statusArea.textContent = 'お使いのブラウザは音声認識に対応していません。Google Chromeなどでお試しください。';
            startButton.disabled = true;
            outputArea.textContent = '音声認識機能を利用できません。';
        }

    </script>

</body>
</html>
